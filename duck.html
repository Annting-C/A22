<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mobile Web Camera + Cycle Sequences</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#000;color:#fff;font-family:Arial,Helvetica, sans-serif;overflow:hidden;height:100vh;padding-top:60px}
  #pageTitle{position:absolute;top:20px;left:50%;transform:translateX(-50%);
             font-size:28px;font-weight:700;letter-spacing:2px;z-index:5;pointer-events:none}
  .media{position:absolute;top:calc(50% + 30px);left:50%;width:360px;height:640px;
         transform:translate(-50%,-50%) scaleX(-1);object-fit:cover;border-radius:20px}
  #video{z-index:1}
  #canvas{z-index:10;pointer-events:none}
  .controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
            display:flex;gap:12px;padding:8px 16px;border-radius:30px;z-index:20;
            background:rgba(0,0,0,.4);backdrop-filter:blur(6px)}
  .controls button,.controls a{width:48px;height:48px;border-radius:50%;border:none;
                               font-size:14px;cursor:pointer;display:flex;align-items:center;
                               justify-content:center;color:#fff;background:#ff9500}
  .controls button:hover,.controls a:hover{background:#e69500}
  #download{display:none;text-decoration:none}
</style>
</head>
<body>
  <div id="pageTitle">SKYWEAVER PASSAGE</div>

  <video id="video" class="media" autoplay playsinline muted></video>
  <canvas id="canvas" class="media"></canvas>

  <div class="controls">
    <button id="camSwitch"  title="切換鏡頭">鏡頭</button>
    <button id="capture"    title="拍照">拍照</button>
    <button id="retake"     title="重拍" style="display:none">重拍</button>
    <button id="seqSwitch"  title="切換序列">序列</button>
    <a      id="download"   title="下載">下載</a>
  </div>

<script>
/* --------- DOM refs --------- */
const video       = document.getElementById('video');
const canvas      = document.getElementById('canvas');
const ctx         = canvas.getContext('2d');
const camSwitch   = document.getElementById('camSwitch');
const captureBtn  = document.getElementById('capture');
const retakeBtn   = document.getElementById('retake');
const seqSwitch   = document.getElementById('seqSwitch');
const dlLink      = document.getElementById('download');

/* --------- Camera --------- */
let stream, currentFacing = 'user';
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:currentFacing,width:360,height:640}, audio:false});
    video.srcObject = stream;
    await video.play();
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
  } catch (err) {
    alert('無法存取鏡頭：'+err.message);
  }
}
camSwitch.onclick = () => {currentFacing = currentFacing==='user'?'environment':'user';startCamera();};

/* --------- Sequence images --------- */
const sequenceFolders=['Duck1','Duck2','Duck3','Duck4'];
const frameCount=364, fps=30, interval=1000/fps;
let imgs=[], currentFrame=0, lastTime=0, seqIdx=0;
async function preload(folder){
  imgs.length=0;                      // reset array
  currentFrame=0;
  const promises=[];
  for (let i=0;i<frameCount;i++){
    promises.push(new Promise(res=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=()=>res(null);
      img.src=`${folder}/${folder}_${String(i).padStart(5,'0')}.webp`;
    }));
  }
  imgs = (await Promise.all(promises)).filter(Boolean);  // drop nulls
  seqSwitch.textContent = folder;
}
seqSwitch.onclick = () => {
  seqIdx = (seqIdx+1)%sequenceFolders.length;
  preload(sequenceFolders[seqIdx]);
};

/* --------- Render loop --------- */
let animationId;
function renderLoop(now){
  animationId = requestAnimationFrame(renderLoop);
  if (!stream) return;            // camera 未開
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if (imgs.length){
    if (now - lastTime >= interval){
      lastTime = now;
      currentFrame = (currentFrame+1)%imgs.length;
    }
    const frame = imgs[currentFrame];
    if (frame) ctx.drawImage(frame,0,0,canvas.width,canvas.height);
  }
}
function startLoop(){
  if (animationId) cancelAnimationFrame(animationId);
  lastTime = performance.now();
  renderLoop(lastTime);
}

/* --------- Capture / Retake --------- */
captureBtn.onclick = () =>{
  if (!stream) return;
  // freeze最新一幀
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const overlay = imgs[currentFrame];
  if (overlay) ctx.drawImage(overlay,0,0,canvas.width,canvas.height);

  cancelAnimationFrame(animationId);        // 暫停動畫
  video.pause();                            // 暫停鏡頭 (不關閉)
  captureBtn.style.display='none';
  retakeBtn.style.display='inline-flex';

  // 下載連結
  const ts=new Date().toISOString().replace(/[:.]/g,'-');
  dlLink.href = canvas.toDataURL('image/png');
  dlLink.download = `photo_${ts}.png`;
  dlLink.style.display='inline-flex';
};

retakeBtn.onclick = () =>{
  video.play();
  startLoop();
  retakeBtn.style.display='none';
  captureBtn.style.display='inline-flex';
  dlLink.style.display='none';
};

/* --------- Init --------- */
(async ()=>{
  await preload(sequenceFolders[0]);
  await startCamera();
  startLoop();
})();
</script>
</body>
</html>
