<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mobile Web Camera + Cycle Sequences (RWD)</title>
<style>
  /* ---------- Reset & 基本 ---------- */
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;height:100vh;overflow:hidden}

  /* ---------- 標題 ---------- */
  #pageTitle{
    position:fixed;top:20px;left:50%;transform:translateX(-50%);
    font-size:20px;font-weight:700;letter-spacing:2px;z-index:5;pointer-events:none
  }

  /* ---------- 主內容：整體下移 100px ---------- */
  main{margin-top:160px;display:flex;flex-direction:column;align-items:center}

  /* ---------- 9:16 Responsive Viewer ---------- */
  #viewer{
    position:relative;                 /* 讓內部絕對定位 */
    width:min(70vw,360px);             /* 小螢幕占 90vw；桌機封頂 560px */
    aspect-ratio:9/16;                 /* 關鍵：固定比例 */
    border-radius:20px;overflow:hidden
  }
  .media{
    position:absolute;inset:0;
    width:100%;height:100%;
    object-fit:cover;border-radius:inherit;
    transform:scaleX(-1)               /* 鏡射 */
  }
  #video{z-index:1}
  #canvas{z-index:10;pointer-events:none}

  /* ---------- 控制列 ---------- */
  .controls{
    margin-top:16px;display:flex;gap:12px;
    background:rgba(0,0,0,.4);backdrop-filter:blur(6px);
    padding:8px 16px;border-radius:30px;z-index:20
  }
  .controls button,.controls a{
    width:48px;height:48px;border-radius:50%;border:none;
    display:flex;align-items:center;justify-content:center;
    font-size:14px;cursor:pointer;color:#fff;background:#ff9500
  }
  .controls button:hover,.controls a:hover{background:#e69500}
  #download{display:none;text-decoration:none}
</style>
</head>
<body>
  <!-- 標題 -->
  <div id="pageTitle">SKYWEAVER PASSAGE</div>

  <!-- 主內容（整體下移） -->
  <main>
    <!-- 影像區 -->
    <div id="viewer">
      <video  id="video"  class="media" autoplay playsinline muted></video>
      <canvas id="canvas" class="media"></canvas>
    </div>

    <!-- 控制列 -->
    <div class="controls">
      <button id="camSwitch"  title="切換鏡頭">鏡頭</button>
      <button id="capture"    title="拍照">拍照</button>
      <button id="retake"     title="重拍" style="display:none">重拍</button>
      <button id="seqSwitch"  title="切換序列">序列</button>
      <a      id="download"   title="下載">下載</a>
    </div>
  </main>

<script>
/* ======  DOM  ====== */
const video      = document.getElementById('video');
const canvas     = document.getElementById('canvas');
const ctx        = canvas.getContext('2d');
const camSwitch  = document.getElementById('camSwitch');
const captureBtn = document.getElementById('capture');
const retakeBtn  = document.getElementById('retake');
const seqSwitch  = document.getElementById('seqSwitch');
const dlLink     = document.getElementById('download');

/* ======  Camera  ====== */
let stream, currentFacing='user';
async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:currentFacing,width:360,height:640},audio:false});
    video.srcObject = stream;
    await video.play();
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
  }catch(err){
    alert('無法存取鏡頭：'+err.message);
  }
}
camSwitch.onclick = () => {
  currentFacing = currentFacing==='user' ? 'environment' : 'user';
  startCamera();
};

/* ======  Sequence images  ====== */
const sequenceFolders=['Duck1','Duck2','Duck3','Duck4'];
const frameCount=364, fps=30, interval=1000/fps;
let imgs=[], currentFrame=0, lastTime=0, seqIdx=0;
async function preload(folder){
  imgs.length=0; currentFrame=0;
  const promises=[];
  for(let i=0;i<frameCount;i++){
    promises.push(new Promise(res=>{
      const img=new Image();
      img.onload = () => res(img);
      img.onerror= () => res(null);
      img.src = `${folder}/${folder}_${String(i).padStart(5,'0')}.webp`;
    }));
  }
  imgs = (await Promise.all(promises)).filter(Boolean);
  seqSwitch.textContent = folder;
}
seqSwitch.onclick = () => {
  seqIdx = (seqIdx+1)%sequenceFolders.length;
  preload(sequenceFolders[seqIdx]);
};

/* ======  Render loop  ====== */
let animationId;
function renderLoop(now){
  animationId = requestAnimationFrame(renderLoop);
  if(!stream) return;                                  // camera 未開
  ctx.drawImage(video,0,0,canvas.width,canvas.height); // 鏡頭

  if(imgs.length){
    if(now-lastTime >= interval){
      lastTime = now;
      currentFrame = (currentFrame+1)%imgs.length;
    }
    const frame = imgs[currentFrame];
    if(frame) ctx.drawImage(frame,0,0,canvas.width,canvas.height); // 序列圖
  }
}
function startLoop(){
  if(animationId) cancelAnimationFrame(animationId);
  lastTime = performance.now();
  renderLoop(lastTime);
}

/* ======  Capture / Retake  ====== */
captureBtn.onclick = ()=>{
  ctx.drawImage(video,0,0,canvas.width,canvas.height); // 固定鏡頭一幀
  const overlay = imgs[currentFrame];
  if(overlay) ctx.drawImage(overlay,0,0,canvas.width,canvas.height);

  cancelAnimationFrame(animationId);
  video.pause();

  captureBtn.style.display='none';
  retakeBtn.style.display='inline-flex';

  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  dlLink.href     = canvas.toDataURL('image/png');
  dlLink.download = `photo_${ts}.png`;
  dlLink.style.display='inline-flex';
};

retakeBtn.onclick = ()=>{
  video.play();
  startLoop();
  retakeBtn.style.display='none';
  captureBtn.style.display='inline-flex';
  dlLink.style.display='none';
};

/* ======  Init  ====== */
(async ()=>{
  await preload(sequenceFolders[0]);
  await startCamera();
  startLoop();
})();
</script>
</body>
</html>
